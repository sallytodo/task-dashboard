<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Dashboard — Sally Williams</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --rose: #e8638b;
    --rose-dark: #d4507a;
    --rose-light: #fce4ec;
    --blush: #f9f1f4;
    --mauve: #b07aab;
    --mauve-light: #f3eaf2;
    --plum: #7c5295;
    --sage: #7eb8a2;
    --sage-light: #e8f5ef;
    --peach: #f4a261;
    --peach-light: #fef0e1;
    --lavender: #a78bca;
    --lavender-light: #f0eaf7;
    --cream: #fdfbf9;
    --warm-white: #fff9f7;
    --text: #4a3f4f;
    --text-light: #8a7f8e;
    --text-muted: #b5adb8;
    --border: #ecdfe8;
    --border-light: #f5eef3;
  }

  body {
    font-family: 'DM Sans', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(160deg, #fdf6f9 0%, #f5eef8 40%, #eef3fb 100%);
    color: var(--text);
    min-height: 100vh;
  }

  /* ─── Top bar ─── */
  .topbar {
    background: linear-gradient(135deg, #d4507a 0%, #b07aab 50%, #8b6bbd 100%);
    padding: 22px 36px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 24px rgba(212,80,122,0.18);
  }

  .topbar h1 {
    font-size: 1.35rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: -0.2px;
  }

  .topbar p {
    color: rgba(255,255,255,0.7);
    font-size: 0.82rem;
    margin-top: 3px;
    font-weight: 400;
  }

  .add-btn {
    padding: 10px 26px;
    border-radius: 50px;
    border: none;
    background: rgba(255,255,255,0.22);
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.25s;
    letter-spacing: 0.2px;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
  }

  .add-btn:hover { background: rgba(255,255,255,0.35); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
  .add-btn:active { transform: translateY(0); }

  /* ─── Main content ─── */
  .main {
    max-width: 1280px;
    margin: 0 auto;
    padding: 28px 36px;
  }

  /* ─── Thursday banner ─── */
  .thursday-banner {
    background: linear-gradient(135deg, #f4a261 0%, #f9c97b 100%);
    border-radius: 14px;
    padding: 14px 22px;
    font-size: 0.85rem;
    color: #5a3600;
    margin-bottom: 22px;
    display: none;
    font-weight: 500;
    border: 1px solid rgba(244,162,97,0.3);
    box-shadow: 0 2px 12px rgba(244,162,97,0.15);
  }

  .thursday-banner strong { color: #3e2200; }

  /* ─── Progress section ─── */
  .progress-section {
    background: var(--warm-white);
    border-radius: 16px;
    padding: 22px 28px;
    margin-bottom: 22px;
    border: 1px solid var(--border);
    box-shadow: 0 2px 12px rgba(180,140,170,0.06);
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .progress-header span {
    font-size: 0.82rem;
    color: var(--text-light);
    font-weight: 600;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-light);
    border-radius: 8px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--rose), var(--mauve), var(--lavender));
    border-radius: 8px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stats {
    display: flex;
    gap: 28px;
    margin-top: 14px;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--text-light);
    font-weight: 500;
  }

  .stat-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .stat-dot.todo { background: var(--rose); }
  .stat-dot.in-progress { background: var(--lavender); }
  .stat-dot.done { background: var(--sage); }
  .stat-dot.waiting { background: var(--peach); }

  /* ─── Filters ─── */
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 22px;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .filter-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-right: 4px;
  }

  .filter-btn {
    padding: 6px 16px;
    border-radius: 50px;
    border: 1px solid var(--border);
    background: var(--warm-white);
    font-size: 0.78rem;
    cursor: pointer;
    color: var(--text);
    transition: all 0.2s;
    font-family: inherit;
    font-weight: 500;
  }

  .filter-btn:hover { background: var(--blush); border-color: var(--rose-light); }

  .filter-btn.active {
    background: linear-gradient(135deg, var(--rose), var(--mauve));
    color: #fff;
    border-color: transparent;
    box-shadow: 0 2px 8px rgba(212,80,122,0.25);
  }

  .filter-separator {
    width: 1px;
    height: 22px;
    background: var(--border);
    margin: 0 8px;
  }

  /* ─── Task grid ─── */
  .task-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 14px;
  }

  /* ─── Task card ─── */
  .task-card {
    background: var(--warm-white);
    border-radius: 14px;
    padding: 0;
    border: 1px solid var(--border);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .task-card:hover {
    box-shadow: 0 8px 28px rgba(180,120,170,0.12);
    transform: translateY(-2px);
    border-color: rgba(176,122,171,0.3);
  }

  .card-color-bar {
    height: 4px;
    width: 100%;
  }

  .card-color-bar.energy-high { background: linear-gradient(90deg, #e8638b, #d4507a); }
  .card-color-bar.energy-medium { background: linear-gradient(90deg, #f4a261, #e8975a); }
  .card-color-bar.energy-low { background: linear-gradient(90deg, #7eb8a2, #6bab94); }
  .card-color-bar.energy- { background: linear-gradient(90deg, #c9bfcc, #b5adb8); }

  .card-body {
    padding: 16px 18px 14px;
  }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }

  .task-name {
    font-size: 0.9rem;
    font-weight: 600;
    line-height: 1.4;
    color: var(--text);
    cursor: pointer;
    flex: 1;
    transition: color 0.2s;
  }

  .task-name:hover { color: var(--rose); }

  .status-pill {
    padding: 4px 14px;
    border-radius: 50px;
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    border: none;
    color: #fff;
    white-space: nowrap;
    transition: all 0.2s;
    font-family: inherit;
    flex-shrink: 0;
  }

  .status-pill:hover { opacity: 0.85; transform: scale(1.05); }

  .status-pill.todo { background: linear-gradient(135deg, #4a3d5c, #5c4e6b); }
  .status-pill.in-progress { background: linear-gradient(135deg, var(--lavender), #9478b8); }
  .status-pill.done { background: linear-gradient(135deg, var(--sage), #6bab94); }
  .status-pill.waiting { background: linear-gradient(135deg, var(--peach), #e8975a); }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
  }

  .tag {
    padding: 3px 10px;
    border-radius: 50px;
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.2px;
  }

  .tag-area {
    background: var(--lavender-light);
    color: var(--plum);
  }

  .tag-energy-high { background: var(--rose-light); color: var(--rose-dark); }
  .tag-energy-medium { background: var(--peach-light); color: #c07830; }
  .tag-energy-low { background: var(--sage-light); color: #4a8a6f; }

  .tag-due { background: #fef5ea; color: #a06020; }
  .tag-recurring { background: var(--mauve-light); color: var(--mauve); }
  .tag-notes { background: var(--border-light); color: var(--text-light); }
  .tag-added { background: #f8f5f6; color: var(--text-muted); font-weight: 500; }

  .task-card.type-work {
    background: linear-gradient(145deg, #fff9fb 0%, #fdf2f6 100%);
    border-color: #f0d6e0;
  }

  .task-card.type-personal {
    background: linear-gradient(145deg, #f9f5fe 0%, #f3edfb 100%);
    border-color: #e2d4f0;
  }

  .task-card.status-done {
    opacity: 0.5;
  }

  .task-card.status-done .task-name {
    text-decoration: line-through;
    color: var(--text-muted);
  }

  .task-card.thursday-highlight {
    border-color: var(--peach);
    box-shadow: 0 0 0 2px rgba(244,162,97,0.25);
  }

  .no-tasks {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 24px;
    color: var(--text-muted);
    font-size: 0.92rem;
  }

  /* ─── Modal ─── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(80,50,70,0.35);
    z-index: 100;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--warm-white);
    border-radius: 18px;
    padding: 30px 34px;
    width: 480px;
    max-width: 94vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 24px 80px rgba(120,70,100,0.2);
    border: 1px solid var(--border);
  }

  .modal h2 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: 22px;
    color: var(--text);
  }

  .form-field { margin-bottom: 16px; }

  .form-field label {
    display: block;
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin-bottom: 6px;
  }

  .form-field input,
  .form-field select,
  .form-field textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.88rem;
    font-family: inherit;
    color: var(--text);
    background: #fff;
    transition: border-color 0.25s, box-shadow 0.25s;
  }

  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: none;
    border-color: var(--rose);
    box-shadow: 0 0 0 3px rgba(232,99,139,0.1);
  }

  .form-field textarea {
    min-height: 80px;
    resize: vertical;
    line-height: 1.5;
  }

  .form-field-row { display: flex; gap: 12px; }
  .form-field-row .form-field { flex: 1; }

  .new-area-input { margin-top: 6px; }

  .form-check {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .form-check input[type="checkbox"] {
    width: 17px;
    height: 17px;
    accent-color: var(--rose);
  }

  .form-check label {
    font-size: 0.85rem;
    color: var(--text);
    cursor: pointer;
    font-weight: 500;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 18px;
    border-top: 1px solid var(--border-light);
  }

  .modal-actions button {
    padding: 10px 24px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }

  .btn-cancel {
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text-light);
  }

  .btn-cancel:hover { background: var(--blush); }

  .btn-save {
    border: none;
    background: linear-gradient(135deg, var(--rose), var(--mauve));
    color: #fff;
    box-shadow: 0 2px 10px rgba(212,80,122,0.25);
  }

  .btn-save:hover { box-shadow: 0 4px 16px rgba(212,80,122,0.35); transform: translateY(-1px); }

  .btn-delete {
    border: 1px solid var(--rose-light);
    background: #fff;
    color: var(--rose);
    margin-right: auto;
  }

  .btn-delete:hover { background: var(--rose-light); }

  /* ─── Settings ─── */
  .topbar-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .settings-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.12);
    color: #fff;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s;
    backdrop-filter: blur(4px);
  }

  .settings-btn:hover { background: rgba(255,255,255,0.25); }

  .settings-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(80,50,70,0.35);
    z-index: 100;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .settings-overlay.open { display: flex; }

  .settings-panel {
    background: var(--warm-white);
    border-radius: 18px;
    padding: 30px 34px;
    width: 500px;
    max-width: 94vw;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 24px 80px rgba(120,70,100,0.2);
    border: 1px solid var(--border);
  }

  .settings-panel h2 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: 22px;
    color: var(--text);
  }

  .settings-section {
    margin-bottom: 22px;
  }

  .settings-section h3 {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin-bottom: 10px;
  }

  .category-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .category-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    transition: all 0.15s;
  }

  .category-row:hover {
    border-color: rgba(176,122,171,0.3);
  }

  .category-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .category-name {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--text);
  }

  .category-count {
    font-size: 0.72rem;
    color: var(--text-muted);
    font-weight: 500;
  }

  .category-delete-btn {
    padding: 5px 14px;
    border-radius: 50px;
    border: 1px solid var(--rose-light);
    background: #fff;
    color: var(--rose);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }

  .category-delete-btn:hover { background: var(--rose-light); }

  .settings-close {
    padding: 10px 24px;
    border-radius: 50px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text-light);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
    margin-top: 6px;
  }

  .settings-close:hover { background: var(--blush); }

  .add-category-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .add-category-input {
    flex: 1;
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.82rem;
    font-family: inherit;
    color: var(--text);
    background: #fff;
    transition: border-color 0.25s, box-shadow 0.25s;
  }

  .add-category-input:focus {
    outline: none;
    border-color: var(--rose);
    box-shadow: 0 0 0 3px rgba(232,99,139,0.1);
  }

  .add-category-btn {
    padding: 8px 18px;
    border-radius: 50px;
    border: none;
    background: linear-gradient(135deg, var(--sage), #6bab94);
    color: #fff;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }

  .add-category-btn:hover { box-shadow: 0 2px 8px rgba(126,184,162,0.35); transform: translateY(-1px); }

  .settings-footer {
    display: flex;
    justify-content: flex-end;
    padding-top: 16px;
    border-top: 1px solid var(--border-light);
  }

  /* ─── Inbox button (topbar) ─── */
  .inbox-btn {
    position: relative;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.12);
    color: #fff;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s;
    backdrop-filter: blur(4px);
  }

  .inbox-btn:hover { background: rgba(255,255,255,0.25); }

  /* ─── Check Email button (topbar) ─── */
  .check-email-btn {
    padding: 8px 18px;
    border-radius: 50px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.12);
    color: #fff;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.25s;
    backdrop-filter: blur(4px);
    letter-spacing: 0.2px;
    white-space: nowrap;
  }

  .check-email-btn:hover { background: rgba(255,255,255,0.25); }
  .check-email-btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .inbox-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--peach);
    color: #fff;
    font-size: 0.62rem;
    font-weight: 700;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(244,162,97,0.4);
  }

  .inbox-badge.hidden { display: none; }

  /* ─── Inbox section ─── */
  .inbox-section {
    background: linear-gradient(145deg, #fef9f4 0%, #fdf5ee 100%);
    border: 1px solid #f0dcc8;
    border-radius: 16px;
    padding: 18px 22px;
    margin-bottom: 22px;
    box-shadow: 0 2px 12px rgba(244,162,97,0.08);
  }

  .inbox-section.hidden { display: none; }

  .inbox-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
  }

  .inbox-header h3 {
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .inbox-count {
    background: var(--peach);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 50px;
  }

  .inbox-toggle {
    font-size: 0.75rem;
    color: var(--text-muted);
    transition: transform 0.2s;
  }

  .inbox-toggle.collapsed { transform: rotate(-90deg); }

  .inbox-list {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .inbox-list.collapsed { display: none; }

  .inbox-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #fff;
    border: 1px solid #f0dcc8;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .inbox-card:hover {
    border-color: var(--peach);
    box-shadow: 0 2px 10px rgba(244,162,97,0.12);
  }

  .inbox-card-info {
    flex: 1;
    min-width: 0;
  }

  .inbox-card-name {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .inbox-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .inbox-card-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }

  .inbox-approve-btn {
    padding: 6px 16px;
    border-radius: 50px;
    border: none;
    background: linear-gradient(135deg, var(--sage), #6bab94);
    color: #fff;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }

  .inbox-approve-btn:hover { box-shadow: 0 2px 8px rgba(126,184,162,0.35); transform: translateY(-1px); }

  .inbox-dismiss-btn {
    padding: 6px 14px;
    border-radius: 50px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }

  .inbox-dismiss-btn:hover { border-color: var(--rose-light); color: var(--rose); }

  /* ─── Responsive ─── */
  @media (max-width: 640px) {
    .main { padding: 16px; }
    .topbar { padding: 16px 18px; }
    .task-grid { grid-template-columns: 1fr; }
    .filters { gap: 6px; }
    .stats { flex-wrap: wrap; gap: 12px; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Sally's Dashboard</h1>
    <p>Money Means &middot; Chief of Staff</p>
  </div>
  <div class="topbar-actions">
    <button class="add-btn" onclick="openModal()">+ New Task</button>
    <button class="inbox-btn" onclick="toggleInbox()" title="Inbox" id="inboxBtn">
      &#9993;
      <span class="inbox-badge hidden" id="inboxBadge">0</span>
    </button>
    <button class="check-email-btn" id="checkEmailBtn" onclick="checkEmail()" title="Check for new email tasks" style="display:none;">Check Email</button>
    <button class="settings-btn" onclick="openSettings()" title="Settings">&#9881;</button>
  </div>
</div>

<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-panel">
    <h2>Settings</h2>
    <div class="settings-section">
      <h3>Work Categories</h3>
      <div class="category-list" id="workCategories"></div>
      <div class="add-category-row">
        <input type="text" id="addWorkCategory" class="add-category-input" placeholder="New category name...">
        <button class="add-category-btn" onclick="addCategory('Work')">Add</button>
      </div>
    </div>
    <div class="settings-section">
      <h3>Personal Categories</h3>
      <div class="category-list" id="personalCategories"></div>
      <div class="add-category-row">
        <input type="text" id="addPersonalCategory" class="add-category-input" placeholder="New category name...">
        <button class="add-category-btn" onclick="addCategory('Personal')">Add</button>
      </div>
    </div>
    <div class="settings-footer">
      <button class="settings-close" onclick="closeSettings()">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">New Task</h2>
    <div class="form-field">
      <label for="taskName">Task name</label>
      <input type="text" id="taskName" placeholder="e.g. Chase Helena re: budget sign-off">
    </div>
    <div class="form-field-row">
      <div class="form-field">
        <label for="taskType">Type</label>
        <select id="taskType" onchange="populateAreaDropdown()">
          <option value="Work" selected>Work</option>
          <option value="Personal">Personal</option>
        </select>
      </div>
      <div class="form-field">
        <label for="taskArea">Category</label>
        <select id="taskArea" onchange="handleAreaChange()"></select>
        <input type="text" id="taskAreaNew" class="new-area-input" placeholder="Type new category name" style="display:none">
      </div>
      <div class="form-field">
        <label for="taskEnergy">Energy</label>
        <select id="taskEnergy">
          <option value="High">High</option>
          <option value="Medium" selected>Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
    </div>
    <div class="form-field-row">
      <div class="form-field">
        <label for="taskStatus">Status</label>
        <select id="taskStatus">
          <option value="To Do" selected>To Do</option>
          <option value="In Progress">In Progress</option>
          <option value="Done">Done</option>
          <option value="Waiting">Waiting</option>
        </select>
      </div>
      <div class="form-field">
        <label for="taskDue">Due date</label>
        <input type="date" id="taskDue">
      </div>
    </div>
    <div class="form-check">
      <input type="checkbox" id="taskRecurring">
      <label for="taskRecurring">Recurring task</label>
    </div>
    <div class="form-field">
      <label for="taskNotes">Notes</label>
      <textarea id="taskNotes" placeholder="Add any notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-delete" id="btnDelete" onclick="deleteTask()" style="display:none">Delete</button>
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" id="btnSave" onclick="saveTask()">Add Task</button>
    </div>
  </div>
</div>

<div class="main">

<div class="thursday-banner" id="thursdayBanner">
  <strong>Thursday tasks:</strong> Invoice payments and Expenses are due today (every other Thursday for expenses).
</div>

<div class="progress-section">
  <div class="progress-header">
    <span>Progress</span>
    <span id="progressText">0 / 0 done</span>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
  </div>
  <div class="stats">
    <div class="stat"><span class="stat-dot todo"></span><span id="statTodo">0 to do</span></div>
    <div class="stat"><span class="stat-dot in-progress"></span><span id="statInProgress">0 in progress</span></div>
    <div class="stat"><span class="stat-dot done"></span><span id="statDone">0 done</span></div>
    <div class="stat"><span class="stat-dot waiting"></span><span id="statWaiting">0 waiting</span></div>
  </div>
</div>

<div class="inbox-section hidden" id="inboxSection">
  <div class="inbox-header" onclick="toggleInboxCollapse()">
    <h3>Inbox <span class="inbox-count" id="inboxCount">0</span></h3>
    <span class="inbox-toggle" id="inboxToggle">&#9660;</span>
  </div>
  <div class="inbox-list" id="inboxList"></div>
</div>

<div class="filters" id="filters"></div>

<div class="task-grid" id="taskGrid"></div>

</div>

<script>
// ─── TASK DATA ───────────────────────────────────────────────────
const tasks = [
  { id: 1,  name: "Decision frameworks 17\u201325 (9 remaining)", area: "Decision Frameworks", energy: "High", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 2,  name: "Catch-up with Syreeta \u2014 kick off handover notes", area: "Syreeta Transition", energy: "High", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 3,  name: "Design team meeting \u2014 testing", area: "Ongoing", energy: "High", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 4,  name: "Frank meeting \u2014 knowledge base discussion", area: "Ongoing", energy: "High", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 5,  name: "Deliver message re: earlier finish date", area: "Syreeta Transition", energy: "Medium", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 6,  name: "Check re: automatic feedback email", area: "Syreeta Transition", energy: "Medium", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 7,  name: "Ask her to draft handover list", area: "Syreeta Transition", energy: "Medium", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 8,  name: "Notion tidy up", area: "Ongoing", energy: "Medium", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 9,  name: "Ideas for improving remote working", area: "Ongoing", energy: "Medium", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 10, name: "Explore Claude projects for automating socials/waitlist", area: "Ongoing", energy: "Medium", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 11, name: "Book exit interview", area: "Syreeta Transition", energy: "Low", status: "To Do", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 12, name: "Expenses", area: "Ongoing", energy: "Low", status: "To Do", type: "Work", recurring: true, thursdayTask: true, due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 13, name: "Invoice payments", area: "Finance", energy: "Low", status: "To Do", type: "Work", recurring: true, thursdayTask: true, due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 14, name: "Payroll", area: "Finance", energy: "Low", status: "To Do", type: "Work", recurring: true, due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 15, name: "Accountant documents", area: "Finance", energy: "Low", status: "To Do", type: "Work", recurring: true, due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 16, name: "Helena \u2014 team day decision", area: "Team Day", energy: "", status: "Waiting", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 17, name: "David Osborne outreach", area: "Syreeta Transition", energy: "", status: "Done", type: "Work", due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 18, name: "Helena \u2014 weekly checkin", area: "Ongoing", energy: "Medium", status: "To Do", type: "Work", recurring: true, due: "9th Feb 2026", added: "5th Feb 2026", notes: "" },
  { id: 24, name: "Book ski transfer", area: "Ongoing", energy: "Medium", status: "To Do", type: "Personal", added: "6th Feb 2026", notes: "" },
  { id: 25, name: "Order under sink storage", area: "Ongoing", energy: "Medium", status: "To Do", type: "Personal", added: "6th Feb 2026", notes: "" },
  { id: 26, name: "Start date", area: "Ongoing", type: "Work", energy: "Medium", status: "To Do", added: "6th Feb 2026", notes: "Reply to Ify re pre-employment tasks ahead of April start date." },
  { id: 27, name: "Book holiday", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "6th Feb 2026", notes: "" },
  { id: 28, name: "Pay Window Cleaner", area: "Ongoing", type: "Personal", energy: "Low", status: "To Do", added: "6th Feb 2026", notes: "" },
  { id: 29, name: "Pay Tutor", area: "Ongoing", type: "Personal", energy: "Low", status: "To Do", added: "6th Feb 2026", notes: "" },
  { id: 30, name: "Pay Stuart", area: "Ongoing", type: "Personal", energy: "Low", status: "To Do", added: "6th Feb 2026", notes: "£20" },
  { id: 31, name: "AMEX card", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "6th Feb 2026", notes: "Set up Ben's card, cancel Sally's card" },
  { id: 33, name: "Book ski lessons", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "6th Feb 2026", notes: "" },
  { id: 34, name: "Book ski hire", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "6th Feb 2026", notes: "" },
  { id: 35, name: "Book Majorca car hire", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "6th Feb 2026", notes: "" },
  { id: 36, name: "Talk to me", area: "Ongoing", type: "Work", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "Behave yourself\nI don't know why it's not talking to me not to talk to me but anyway it's telling me instead send it" },
  { id: 37, name: "ASOS returns", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
  { id: 38, name: "Order ufh", area: "Ongoing", type: "Personal", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "Category - house" },
  { id: 39, name: "Test", area: "Misc", type: "Work", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
  { id: 41, name: "Put on washing", area: "Misc", type: "Work", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
  { id: 42, name: "Dishwasher", area: "Misc", type: "Work", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
  { id: 43, name: "Television", area: "Misc", type: "Personal", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
  { id: 44, name: "Sofa", area: "Misc", type: "Personal", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
  { id: 45, name: "Get rich", area: "Misc", type: "Personal", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
];

// ─── INBOX DATA ─────────────────────────────────────────────────
const inbox = [
  { id: 46, name: "Pick up dry cleaning", area: "Misc", type: "Personal", energy: "Medium", status: "To Do", added: "7th Feb 2026", notes: "" },
];

// ─── STATE ───────────────────────────────────────────────────────
let activeFilters = { status: new Set(["All"]), energy: new Set(["All"]), area: new Set(["All"]), type: new Set(["All"]) };
let editingTaskId = null;
const customCategories = { Work: ["Misc"], Personal: ["Misc"] };

// ─── THURSDAY CHECK ──────────────────────────────────────────────
const today = new Date();
if (today.getDay() === 4) {
  document.getElementById("thursdayBanner").style.display = "block";
}

// ─── BUILD FILTERS ───────────────────────────────────────────────
function buildFilters() {
  const container = document.getElementById("filters");
  // Filter categories based on selected type
  const typeFilter = activeFilters.type;
  const filteredTasks = typeFilter.has("All") ? tasks : tasks.filter(t => typeFilter.has(t.type || "Work"));
  const areas = [...new Set(filteredTasks.map(t => t.area))].sort();

  // If selected categories no longer exist in filtered list, reset to All
  if (!activeFilters.area.has("All")) {
    const valid = new Set(areas);
    for (const a of activeFilters.area) {
      if (!valid.has(a)) activeFilters.area.delete(a);
    }
    if (activeFilters.area.size === 0) activeFilters.area.add("All");
  }

  const groups = [
    { label: "Type", key: "type", options: ["All", "Work", "Personal"] },
    { label: "Status", key: "status", options: ["All", "To Do", "In Progress", "Done", "Waiting"] },
    { label: "Energy", key: "energy", options: ["All", "High", "Medium", "Low"] },
    { label: "Category", key: "area", options: ["All", ...areas] },
  ];

  container.innerHTML = "";
  groups.forEach((group, gi) => {
    if (gi > 0) {
      const sep = document.createElement("div");
      sep.className = "filter-separator";
      container.appendChild(sep);
    }
    const fg = document.createElement("div");
    fg.className = "filter-group";
    fg.innerHTML = '<span class="filter-label">' + group.label + '</span>';
    group.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "filter-btn" + (activeFilters[group.key].has(opt) ? " active" : "");
      btn.textContent = opt;
      btn.addEventListener("click", () => {
        const f = activeFilters[group.key];
        if (opt === "All") {
          f.clear();
          f.add("All");
        } else {
          f.delete("All");
          if (f.has(opt)) { f.delete(opt); } else { f.add(opt); }
          if (f.size === 0) f.add("All");
        }
        buildFilters();
        render();
      });
      fg.appendChild(btn);
    });
    container.appendChild(fg);
  });
}

// ─── STATUS CYCLE ────────────────────────────────────────────────
const statusCycle = ["To Do", "In Progress", "Done", "Waiting"];
function cycleStatus(task) {
  const idx = statusCycle.indexOf(task.status);
  task.status = statusCycle[(idx + 1) % statusCycle.length];
  render();
}

// ─── RENDER ──────────────────────────────────────────────────────
function render() {
  const grid = document.getElementById("taskGrid");
  const isThursday = today.getDay() === 4;

  const filtered = tasks.filter(t => {
    if (!activeFilters.type.has("All") && !activeFilters.type.has(t.type || "Work")) return false;
    if (!activeFilters.status.has("All") && !activeFilters.status.has(t.status)) return false;
    if (!activeFilters.energy.has("All") && !activeFilters.energy.has(t.energy)) return false;
    if (!activeFilters.area.has("All") && !activeFilters.area.has(t.area)) return false;
    return true;
  });

  // Stats
  const todoCount = tasks.filter(t => t.status === "To Do").length;
  const doneCount = tasks.filter(t => t.status === "Done").length;
  const waitingCount = tasks.filter(t => t.status === "Waiting").length;
  const total = tasks.length;
  const pct = total > 0 ? Math.round((doneCount / total) * 100) : 0;

  document.getElementById("progressFill").style.width = pct + "%";
  document.getElementById("progressText").textContent = doneCount + " / " + total + " done (" + pct + "%)";
  const inProgressCount = tasks.filter(t => t.status === "In Progress").length;
  document.getElementById("statTodo").textContent = todoCount + " to do";
  document.getElementById("statInProgress").textContent = inProgressCount + " in progress";
  document.getElementById("statDone").textContent = doneCount + " done";
  document.getElementById("statWaiting").textContent = waitingCount + " waiting";

  if (filtered.length === 0) {
    grid.innerHTML = '<div class="no-tasks">No tasks match these filters.</div>';
    return;
  }

  grid.innerHTML = filtered.map(t => {
    const eLower = t.energy ? t.energy.toLowerCase() : "";
    const sLower = t.status.toLowerCase().replace(/ /g, "-");
    const tLower = (t.type || "Work").toLowerCase();
    const highlight = isThursday && t.thursdayTask ? " thursday-highlight" : "";

    // Status pill
    const statusClass = "status-pill " + sLower;
    const statusLabel = t.status;

    // Tags
    let tags = '';
    tags += '<span class="tag tag-area">' + escapeHtml(t.area) + '</span>';
    if (t.energy) {
      tags += '<span class="tag tag-energy-' + eLower + '">' + t.energy + '</span>';
    }
    if (t.due) {
      tags += '<span class="tag tag-due">' + escapeHtml(t.due) + '</span>';
    }
    if (t.recurring) {
      tags += '<span class="tag tag-recurring">Recurring</span>';
    }
    if (t.notes && t.notes.trim()) {
      tags += '<span class="tag tag-notes">Notes</span>';
    }

    return '<div class="task-card status-' + sLower + ' type-' + tLower + highlight + '" data-card-id="' + t.id + '">' +
      '<div class="card-color-bar energy-' + eLower + '"></div>' +
      '<div class="card-body">' +
        '<div class="card-top">' +
          '<div class="task-name" data-edit-id="' + t.id + '">' + escapeHtml(t.name) + '</div>' +
          '<button class="' + statusClass + '" data-id="' + t.id + '" title="Click to change status">' + statusLabel + '</button>' +
        '</div>' +
        '<div class="card-meta">' + tags + '</div>' +
      '</div>' +
      '</div>';
  }).join("");

  // Status pill handlers
  grid.querySelectorAll(".status-pill").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const id = parseInt(btn.getAttribute("data-id"));
      const task = tasks.find(t => t.id === id);
      if (task) { cycleStatus(task); buildFilters(); }
    });
  });

  // Card click → open edit modal
  grid.querySelectorAll("[data-card-id]").forEach(el => {
    el.addEventListener("click", () => {
      openEditModal(parseInt(el.getAttribute("data-card-id")));
    });
  });
}

function escapeHtml(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

// ─── MODAL ───────────────────────────────────────────────────────
function populateAreaDropdown(selectedArea) {
  const sel = document.getElementById("taskArea");
  const selectedType = document.getElementById("taskType").value;
  const areas = getCategoriesForType(selectedType);
  sel.innerHTML = areas.map(a => '<option value="' + escapeHtml(a) + '">' + escapeHtml(a) + '</option>').join("")
    + '<option value="__new__">+ Add new category</option>';
  if (selectedArea && areas.includes(selectedArea)) {
    sel.value = selectedArea;
  } else if (areas.length > 0) {
    sel.value = areas[0];
  }
  document.getElementById("taskAreaNew").style.display = "none";
  document.getElementById("taskAreaNew").value = "";
}

function openModal() {
  editingTaskId = null;
  document.getElementById("modalTitle").textContent = "New Task";
  document.getElementById("btnSave").textContent = "Add Task";
  document.getElementById("btnDelete").style.display = "none";
  document.getElementById("taskName").value = "";
  document.getElementById("taskType").value = "Work";
  populateAreaDropdown("Misc");
  document.getElementById("taskEnergy").value = "Medium";
  document.getElementById("taskStatus").value = "To Do";
  document.getElementById("taskDue").value = "";
  document.getElementById("taskRecurring").checked = false;
  document.getElementById("taskNotes").value = "";
  document.getElementById("modalOverlay").classList.add("open");
  document.getElementById("taskName").focus();
}

function openEditModal(id) {
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  editingTaskId = id;
  document.getElementById("modalTitle").textContent = "Edit Task";
  document.getElementById("btnSave").textContent = "Save Changes";
  document.getElementById("btnDelete").style.display = "inline-block";
  document.getElementById("taskName").value = task.name;
  document.getElementById("taskType").value = task.type || "Work";
  populateAreaDropdown(task.area);
  document.getElementById("taskEnergy").value = task.energy || "Medium";
  document.getElementById("taskStatus").value = task.status;
  document.getElementById("taskDue").value = parseDateToInput(task.due);
  document.getElementById("taskRecurring").checked = !!task.recurring;
  document.getElementById("taskNotes").value = task.notes || "";
  document.getElementById("modalOverlay").classList.add("open");
  document.getElementById("taskName").focus();
}

function parseDateToInput(dateStr) {
  if (!dateStr) return "";
  const months = { Jan:"01", Feb:"02", Mar:"03", Apr:"04", May:"05", Jun:"06",
                   Jul:"07", Aug:"08", Sep:"09", Oct:"10", Nov:"11", Dec:"12" };
  const m = dateStr.match(/(\d+)\w*\s+(\w+)\s+(\d{4})/);
  if (!m) return "";
  return m[3] + "-" + (months[m[2]] || "01") + "-" + m[1].padStart(2, "0");
}

function handleAreaChange() {
  const sel = document.getElementById("taskArea");
  const newInput = document.getElementById("taskAreaNew");
  if (sel.value === "__new__") { newInput.style.display = "block"; newInput.focus(); }
  else { newInput.style.display = "none"; newInput.value = ""; }
}

function closeModal() {
  document.getElementById("modalOverlay").classList.remove("open");
  editingTaskId = null;
  editingInboxIdx = null;
  document.getElementById("btnDelete").textContent = "Delete";
}

function formatTodayDate() {
  const d = new Date();
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const day = d.getDate();
  const s = (day===1||day===21||day===31)?"st":(day===2||day===22)?"nd":(day===3||day===23)?"rd":"th";
  return day + s + " " + months[d.getMonth()] + " " + d.getFullYear();
}

function formatDateValue(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr + "T00:00:00");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const day = d.getDate();
  const s = (day===1||day===21||day===31)?"st":(day===2||day===22)?"nd":(day===3||day===23)?"rd":"th";
  return day + s + " " + months[d.getMonth()] + " " + d.getFullYear();
}

function getFormArea() {
  const v = document.getElementById("taskArea").value;
  if (v === "__new__") {
    const n = document.getElementById("taskAreaNew").value.trim();
    if (!n) { document.getElementById("taskAreaNew").focus(); return null; }
    return n;
  }
  return v;
}

function saveTask() {
  const name = document.getElementById("taskName").value.trim();
  if (!name) { document.getElementById("taskName").focus(); return; }
  const area = getFormArea();
  if (area === null) return;

  const type = document.getElementById("taskType").value;
  const energy = document.getElementById("taskEnergy").value;
  const status = document.getElementById("taskStatus").value;
  const due = formatDateValue(document.getElementById("taskDue").value);
  const recurring = document.getElementById("taskRecurring").checked;
  const notes = document.getElementById("taskNotes").value;

  if (editingInboxIdx !== null) {
    // Approving from inbox with edits
    const maxId = Math.max(
      tasks.reduce((m, t) => Math.max(m, t.id), 0),
      inbox.reduce((m, t) => Math.max(m, t.id || 0), 0)
    );
    tasks.push({ id: maxId+1, name, area, type, energy, status, due, added: inbox[editingInboxIdx].added || formatTodayDate(), recurring, notes });
    inbox.splice(editingInboxIdx, 1);
    editingInboxIdx = null;
    closeModal(); buildFilters(); render(); renderInbox();
  } else if (editingTaskId !== null) {
    const task = tasks.find(t => t.id === editingTaskId);
    if (task) {
      task.name = name; task.area = area; task.type = type; task.energy = energy;
      task.status = status; task.due = due; task.recurring = recurring; task.notes = notes;
    }
    closeModal(); buildFilters(); render();
  } else {
    const maxId = Math.max(
      tasks.reduce((m, t) => Math.max(m, t.id), 0),
      inbox.reduce((m, t) => Math.max(m, t.id || 0), 0)
    );
    tasks.push({ id: maxId+1, name, area, type, energy, status, due, added: formatTodayDate(), recurring, notes });
    closeModal(); buildFilters(); render();
  }
}

function deleteTask() {
  if (editingInboxIdx !== null) {
    const item = inbox[editingInboxIdx];
    if (item && confirm('Dismiss "' + item.name + '" from inbox?')) {
      inbox.splice(editingInboxIdx, 1);
      editingInboxIdx = null;
      closeModal(); renderInbox();
    }
    return;
  }
  if (editingTaskId === null) return;
  const task = tasks.find(t => t.id === editingTaskId);
  if (task && confirm('Delete "' + task.name + '"?')) {
    tasks.splice(tasks.indexOf(task), 1);
    closeModal(); buildFilters(); render();
  }
}

document.getElementById("modalOverlay").addEventListener("click", (e) => {
  if (e.target === document.getElementById("modalOverlay")) closeModal();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") { closeModal(); closeSettings(); }
});

// ─── SETTINGS ───────────────────────────────────────────────────
function openSettings() {
  renderSettings();
  document.getElementById("settingsOverlay").classList.add("open");
}

function closeSettings() {
  document.getElementById("settingsOverlay").classList.remove("open");
}

function renderSettings() {
  ["Work", "Personal"].forEach(type => {
    const containerId = type === "Work" ? "workCategories" : "personalCategories";
    const container = document.getElementById(containerId);
    const allCats = getCategoriesForType(type);
    const typeTasks = tasks.filter(t => (t.type || "Work") === type);
    const cats = {};
    allCats.forEach(c => { cats[c] = 0; });
    typeTasks.forEach(t => { cats[t.area] = (cats[t.area] || 0) + 1; });
    const sorted = Object.keys(cats).sort();

    if (sorted.length === 0) {
      container.innerHTML = '<div style="font-size:0.82rem;color:var(--text-muted);padding:8px 0;">No categories</div>';
      return;
    }

    container.innerHTML = sorted.map(cat => {
      const count = cats[cat];
      const isMisc = cat === "Misc";
      return '<div class="category-row">' +
        '<div class="category-info">' +
          '<span class="category-name">' + escapeHtml(cat) + '</span>' +
          '<span class="category-count">' + count + ' task' + (count !== 1 ? 's' : '') + '</span>' +
        '</div>' +
        (isMisc ? '' : '<button class="category-delete-btn" data-cat="' + escapeHtml(cat) + '" data-type="' + type + '">Delete</button>') +
      '</div>';
    }).join("");

    container.querySelectorAll(".category-delete-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const cat = btn.getAttribute("data-cat");
        const catType = btn.getAttribute("data-type");
        deleteCategory(cat, catType);
      });
    });
  });
}

function deleteCategory(cat, type) {
  if (cat === "Misc") return;
  const affected = tasks.filter(t => t.area === cat && (t.type || "Work") === type);

  if (affected.length > 0) {
    const otherCats = getCategoriesForType(type).filter(c => c !== cat);
    const fallback = "Misc";

    let moveTo = fallback;
    if (otherCats.length > 1) {
      moveTo = prompt(
        'Delete "' + cat + '"? (' + affected.length + ' task' + (affected.length !== 1 ? 's' : '') + ' will move)\n\n' +
        'Move tasks to which category?\n' + otherCats.join(', '),
        fallback
      );
      if (moveTo === null) return;
      if (!otherCats.includes(moveTo)) moveTo = fallback;
    } else {
      if (!confirm('Delete "' + cat + '"? ' + affected.length + ' task' + (affected.length !== 1 ? 's' : '') + ' will move to "Misc".')) return;
    }

    affected.forEach(t => { t.area = moveTo; });
  } else {
    if (!confirm('Delete empty category "' + cat + '"?')) return;
  }

  // Remove from customCategories if present
  const idx = customCategories[type].indexOf(cat);
  if (idx !== -1) customCategories[type].splice(idx, 1);

  renderSettings();
  buildFilters();
  render();
}

function getCategoriesForType(type) {
  const typeTasks = tasks.filter(t => (t.type || "Work") === type);
  const fromTasks = typeTasks.map(t => t.area);
  const fromCustom = customCategories[type] || [];
  return [...new Set([...fromTasks, ...fromCustom])].sort();
}

function addCategory(type) {
  const inputId = type === "Work" ? "addWorkCategory" : "addPersonalCategory";
  const input = document.getElementById(inputId);
  const name = input.value.trim();
  if (!name) { input.focus(); return; }

  const allCats = getCategoriesForType(type);
  if (allCats.includes(name)) {
    alert('Category "' + name + '" already exists for ' + type + '.');
    return;
  }

  customCategories[type].push(name);
  input.value = "";
  renderSettings();
  buildFilters();
}

document.getElementById("settingsOverlay").addEventListener("click", (e) => {
  if (e.target === document.getElementById("settingsOverlay")) closeSettings();
});

document.getElementById("addWorkCategory").addEventListener("keydown", (e) => {
  if (e.key === "Enter") addCategory("Work");
});
document.getElementById("addPersonalCategory").addEventListener("keydown", (e) => {
  if (e.key === "Enter") addCategory("Personal");
});

// ─── INBOX ──────────────────────────────────────────────────────
let inboxCollapsed = false;
let editingInboxIdx = null;

function updateInboxBadge() {
  const badge = document.getElementById("inboxBadge");
  const section = document.getElementById("inboxSection");
  const countEl = document.getElementById("inboxCount");
  if (inbox.length > 0) {
    badge.textContent = inbox.length;
    badge.classList.remove("hidden");
    section.classList.remove("hidden");
    countEl.textContent = inbox.length;
  } else {
    badge.classList.add("hidden");
    section.classList.add("hidden");
  }
}

function toggleInbox() {
  const section = document.getElementById("inboxSection");
  if (inbox.length === 0) return;
  if (section.classList.contains("hidden")) {
    section.classList.remove("hidden");
  } else {
    section.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}

function toggleInboxCollapse() {
  inboxCollapsed = !inboxCollapsed;
  document.getElementById("inboxList").classList.toggle("collapsed", inboxCollapsed);
  document.getElementById("inboxToggle").classList.toggle("collapsed", inboxCollapsed);
}

function renderInbox() {
  updateInboxBadge();
  const list = document.getElementById("inboxList");
  if (inbox.length === 0) { list.innerHTML = ""; return; }

  list.innerHTML = inbox.map((item, idx) => {
    const eLower = item.energy ? item.energy.toLowerCase() : "";
    const tLower = (item.type || "Work").toLowerCase();
    let tags = '';
    tags += '<span class="tag tag-area">' + escapeHtml(item.area || "Misc") + '</span>';
    if (tLower === "work") {
      tags += '<span class="tag" style="background:var(--rose-light);color:var(--rose-dark);">Work</span>';
    } else {
      tags += '<span class="tag" style="background:var(--lavender-light);color:var(--plum);">Personal</span>';
    }
    if (item.energy) {
      tags += '<span class="tag tag-energy-' + eLower + '">' + item.energy + '</span>';
    }

    return '<div class="inbox-card" data-inbox-idx="' + idx + '">' +
      '<div class="inbox-card-info">' +
        '<div class="inbox-card-name">' + escapeHtml(item.name) + '</div>' +
        '<div class="inbox-card-meta">' + tags + '</div>' +
      '</div>' +
      '<div class="inbox-card-actions">' +
        '<button class="inbox-approve-btn" data-approve-idx="' + idx + '">Approve</button>' +
        '<button class="inbox-dismiss-btn" data-dismiss-idx="' + idx + '">Dismiss</button>' +
      '</div>' +
    '</div>';
  }).join("");

  // Card click → open edit modal pre-filled
  list.querySelectorAll("[data-inbox-idx]").forEach(el => {
    el.addEventListener("click", (e) => {
      if (e.target.closest("[data-approve-idx]") || e.target.closest("[data-dismiss-idx]")) return;
      openInboxEditModal(parseInt(el.getAttribute("data-inbox-idx")));
    });
  });

  // Approve button
  list.querySelectorAll("[data-approve-idx]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      approveInboxItem(parseInt(btn.getAttribute("data-approve-idx")));
    });
  });

  // Dismiss button
  list.querySelectorAll("[data-dismiss-idx]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      dismissInboxItem(parseInt(btn.getAttribute("data-dismiss-idx")));
    });
  });
}

function approveInboxItem(idx) {
  const item = inbox[idx];
  if (!item) return;
  const originalId = item.id;
  const maxId = Math.max(
    tasks.reduce((m, t) => Math.max(m, t.id), 0),
    inbox.reduce((m, t) => Math.max(m, t.id || 0), 0)
  );
  item.id = maxId + 1;
  tasks.push(item);
  inbox.splice(idx, 1);
  renderInbox();
  buildFilters();
  render();
  // Persist to disk using the original ID (what's on disk)
  if (location.protocol !== "file:") {
    fetch("/api/approve-inbox", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: originalId })
    }).catch(() => {});
  }
}

function dismissInboxItem(idx) {
  const item = inbox[idx];
  if (!item) return;
  if (confirm('Dismiss "' + item.name + '" from inbox?')) {
    inbox.splice(idx, 1);
    renderInbox();
    // Persist to disk if served via HTTP
    if (location.protocol !== "file:") {
      fetch("/api/dismiss-inbox", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: item.id })
      }).catch(() => {});
    }
  }
}

function openInboxEditModal(idx) {
  const item = inbox[idx];
  if (!item) return;
  editingInboxIdx = idx;
  editingTaskId = null;
  document.getElementById("modalTitle").textContent = "Review Inbox Task";
  document.getElementById("btnSave").textContent = "Approve";
  document.getElementById("btnDelete").style.display = "inline-block";
  document.getElementById("btnDelete").textContent = "Dismiss";
  document.getElementById("taskName").value = item.name;
  document.getElementById("taskType").value = item.type || "Work";
  populateAreaDropdown(item.area);
  document.getElementById("taskEnergy").value = item.energy || "Medium";
  document.getElementById("taskStatus").value = item.status || "To Do";
  document.getElementById("taskDue").value = parseDateToInput(item.due);
  document.getElementById("taskRecurring").checked = !!item.recurring;
  document.getElementById("taskNotes").value = item.notes || "";
  document.getElementById("modalOverlay").classList.add("open");
  document.getElementById("taskName").focus();
}

// ─── CHECK EMAIL ─────────────────────────────────────────────────
function checkEmail() {
  const btn = document.getElementById("checkEmailBtn");
  btn.disabled = true;
  btn.textContent = "Checking\u2026";
  fetch("/api/check-tasks", { method: "POST" })
    .then(r => r.json())
    .then(data => {
      if (data.created > 0) {
        location.reload();
      } else {
        btn.textContent = data.message || "No new tasks";
        setTimeout(() => { btn.textContent = "Check Email"; btn.disabled = false; }, 2500);
      }
    })
    .catch(() => {
      btn.textContent = "Server offline";
      setTimeout(() => { btn.textContent = "Check Email"; btn.disabled = false; }, 2500);
    });
}

// ─── INIT ────────────────────────────────────────────────────────
// Show check-email button only when served via HTTP (not file://)
if (location.protocol === "http:" || location.protocol === "https:") {
  document.getElementById("checkEmailBtn").style.display = "";
}
buildFilters();
render();
renderInbox();
</script>

</body>
</html>
